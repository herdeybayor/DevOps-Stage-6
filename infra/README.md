# Infrastructure Documentation

This directory contains all infrastructure-as-code (IaC) and configuration management files for the DevOps Stage 6 project.

## ğŸ“ Directory Structure

```
infra/
â”œâ”€â”€ terraform/              # Infrastructure provisioning
â”‚   â”œâ”€â”€ backend.tf         # Terraform backend configuration
â”‚   â”œâ”€â”€ variables.tf       # Input variables
â”‚   â”œâ”€â”€ main.tf           # Main VPC and networking
â”‚   â”œâ”€â”€ ec2.tf            # EC2 instance configuration
â”‚   â”œâ”€â”€ security_groups.tf # Security group rules
â”‚   â”œâ”€â”€ ansible.tf        # Terraform-Ansible integration
â”‚   â”œâ”€â”€ outputs.tf        # Output values
â”‚   â””â”€â”€ terraform.tfvars.example
â”‚
â””â”€â”€ ansible/               # Configuration management
    â”œâ”€â”€ ansible.cfg       # Ansible configuration
    â”œâ”€â”€ playbook.yml      # Main playbook
    â”œâ”€â”€ inventory/        # Inventory files
    â”‚   â”œâ”€â”€ hosts.example
    â”‚   â””â”€â”€ hosts.tpl     # Template (generated by Terraform)
    â””â”€â”€ roles/            # Ansible roles
        â”œâ”€â”€ dependencies/ # Install Docker, Git, etc.
        â””â”€â”€ deploy/       # Deploy application

```

## ğŸ—ï¸ Terraform

### Overview

Terraform provisions the complete AWS infrastructure including:
- VPC with public subnet
- Internet Gateway and routing
- EC2 instance (Ubuntu 22.04)
- Security Groups (SSH, HTTP, HTTPS)
- Elastic IP
- Ansible inventory generation
- Automatic Ansible execution

### Prerequisites

```bash
# Install Terraform
brew install terraform  # macOS
# or download from https://www.terraform.io/downloads

# Verify installation
terraform version
```

### Initial Setup

1. **Configure AWS Credentials**

```bash
# Option 1: Environment variables
export AWS_ACCESS_KEY_ID="your-access-key"
export AWS_SECRET_ACCESS_KEY="your-secret-key"

# Option 2: AWS CLI profile
aws configure
```

2. **Create Terraform Variables File**

```bash
cd terraform/
cp terraform.tfvars.example terraform.tfvars
nano terraform.tfvars
```

Required variables:
- `key_name`: Your AWS SSH key pair name
- `domain_name`: Your domain
- `letsencrypt_email`: Email for SSL certificates
- `jwt_secret`: Secret for JWT authentication
- `github_repo_url`: Your GitHub repository URL

3. **Initialize Terraform**

```bash
terraform init
```

### Remote State Backend (Optional but Recommended)

For production, configure S3 backend for state storage:

1. **Create S3 Bucket and DynamoDB Table**

```bash
# Create S3 bucket
aws s3api create-bucket \
  --bucket devops-stage6-terraform-state \
  --region us-east-1

# Enable versioning
aws s3api put-bucket-versioning \
  --bucket devops-stage6-terraform-state \
  --versioning-configuration Status=Enabled

# Create DynamoDB table for state locking
aws dynamodb create-table \
  --table-name terraform-state-lock \
  --attribute-definitions AttributeName=LockID,AttributeType=S \
  --key-schema AttributeName=LockID,KeyType=HASH \
  --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
  --region us-east-1
```

2. **Uncomment Backend Configuration**

In `backend.tf`, uncomment the S3 backend block and run:

```bash
terraform init -migrate-state
```

### Terraform Commands

```bash
# Format code
terraform fmt

# Validate configuration
terraform validate

# Plan changes
terraform plan

# Apply changes
terraform apply

# Apply without confirmation
terraform apply -auto-approve

# Destroy infrastructure
terraform destroy

# Show current state
terraform show

# List outputs
terraform output

# Refresh state
terraform refresh
```

### Important Notes

- **Idempotent**: Running `terraform apply` multiple times is safe
- **Drift Detection**: Use `terraform plan` to detect manual changes
- **State File**: Never commit `terraform.tfstate` to Git
- **Secrets**: Never commit `terraform.tfvars` with real values

## ğŸ¤– Ansible

### Overview

Ansible handles:
- Server configuration (Docker, Git, firewall)
- Application deployment
- Service management
- Automatic updates

### Prerequisites

```bash
# Install Ansible
pip install ansible

# Or on Ubuntu/Debian
sudo apt-get install ansible

# Or on macOS
brew install ansible

# Verify installation
ansible --version

# Install required collections
ansible-galaxy collection install community.docker
```

### Roles

#### 1. Dependencies Role

Installs and configures:
- Docker CE
- Docker Compose
- Git
- Python packages
- UFW firewall
- System packages

#### 2. Deploy Role

Handles:
- Repository cloning/updating
- Environment configuration
- Docker image building
- Container orchestration
- Health checks
- Log rotation

### Running Ansible Manually

```bash
cd ansible/

# Check inventory
ansible-inventory --list -i inventory/hosts

# Test connectivity
ansible all -m ping -i inventory/hosts

# Run full playbook
ansible-playbook -i inventory/hosts playbook.yml

# Run with extra variables
ansible-playbook -i inventory/hosts \
  --extra-vars "@extra_vars.yml" \
  playbook.yml

# Run specific role
ansible-playbook -i inventory/hosts playbook.yml --tags dependencies

# Dry run
ansible-playbook -i inventory/hosts playbook.yml --check

# Verbose output
ansible-playbook -i inventory/hosts playbook.yml -vvv
```

### Inventory

The inventory file is automatically generated by Terraform but can be created manually:

```ini
[app_servers]
app-server ansible_host=1.2.3.4 ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/your-key.pem
```

### Variables

Variables are defined in:
1. `extra_vars.yml` (generated by Terraform)
2. Role defaults
3. Playbook vars

Example `extra_vars.yml`:

```yaml
domain_name: "example.com"
letsencrypt_email: "admin@example.com"
jwt_secret: "your-secret-key"
github_repo_url: "https://github.com/user/repo"
app_directory: "/home/ubuntu/app"
```

## ğŸ”„ Terraform + Ansible Integration

The integration is handled in `terraform/ansible.tf`:

1. **Inventory Generation**: Terraform creates Ansible inventory with server IP
2. **Variable Passing**: Terraform variables passed to Ansible
3. **Automatic Execution**: Ansible runs automatically after Terraform apply
4. **Dependency Management**: Proper ordering ensures server is ready

### Workflow

```
Terraform Plan â†’ Provision AWS â†’ Generate Inventory â†’ Run Ansible â†’ Deploy App
```

### Manual Override

If you need to run Ansible separately:

```bash
# Terraform only (skip Ansible)
terraform apply -target=aws_instance.app_server

# Then run Ansible manually
cd ../ansible
ansible-playbook -i inventory/hosts playbook.yml
```

## ğŸ”’ Security Considerations

### Terraform

- âœ… State encryption enabled
- âœ… Variables marked as sensitive
- âœ… Security groups follow least privilege
- âœ… Instance metadata v2 enforced (optional)

### Ansible

- âœ… SSH key authentication only
- âœ… Become/sudo properly configured
- âœ… Secrets passed via environment variables
- âœ… No passwords in playbooks

### Best Practices

1. **Never commit secrets**:
   - Add `*.tfvars` to `.gitignore`
   - Use environment variables or secret managers
   
2. **Restrict SSH access**:
   - Update `allowed_ssh_cidr` in `terraform.tfvars`
   - Use VPN or bastion host for production

3. **Enable state locking**:
   - Use S3 + DynamoDB backend
   - Prevents concurrent modifications

4. **Regular updates**:
   - Keep Terraform/Ansible versions current
   - Update AMIs regularly
   - Patch security vulnerabilities

## ğŸ“Š Monitoring & Maintenance

### Check Infrastructure

```bash
# Terraform state
terraform state list
terraform state show aws_instance.app_server

# Ansible facts
ansible app_servers -m setup -i inventory/hosts
```

### Update Application

```bash
# Pull latest code and rebuild
ansible-playbook -i inventory/hosts playbook.yml --tags deploy
```

### Troubleshooting

**Terraform Issues:**

```bash
# Refresh state
terraform refresh

# Show detailed logs
TF_LOG=DEBUG terraform apply

# Unlock state (if locked)
terraform force-unlock <lock-id>
```

**Ansible Issues:**

```bash
# Test SSH connectivity
ssh -i ~/.ssh/your-key.pem ubuntu@server-ip

# Verbose Ansible output
ansible-playbook -i inventory/hosts playbook.yml -vvv

# Check syntax
ansible-playbook playbook.yml --syntax-check
```

## ğŸ”„ CI/CD Integration

The infrastructure is integrated with GitHub Actions:

1. **Workflow trigger**: Changes to `infra/` directory
2. **Drift detection**: Automated plan and drift checking
3. **Email notifications**: Sent on drift detection
4. **Manual approval**: Required before applying changes
5. **Automatic deployment**: On approval

See [GitHub Actions workflows](../.github/workflows/) for details.

## ğŸ“š Additional Resources

- [Terraform AWS Provider Docs](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [Ansible Documentation](https://docs.ansible.com/)
- [AWS EC2 Best Practices](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-best-practices.html)
- [Docker Best Practices](https://docs.docker.com/develop/dev-best-practices/)

## ğŸ†˜ Support

For issues or questions:
1. Check the main [README](../README.md)
2. Review Terraform/Ansible output logs
3. Verify AWS permissions
4. Ensure all prerequisites are met

---

**Maintained as part of HNG DevOps Internship - Stage 6**

